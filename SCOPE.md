# Рамки MVP и гвардрайлы

## Цель MVP

Создать минимально жизнеспособный продукт для поиска автомобильных фильтров по каталогам производителей в Аргентине.

## Область применения MVP

### ✅ Включено в MVP

**География и источники:**
- Аргентина
- Каталоги: MANN, FRAM, MARENO, MAHLE, WEGA
- PDF → CSV → PostgreSQL pipeline

**Функциональность:**
- Один API эндпоинт: `POST /api/lookup`
- Поиск по make, model, year
- Возврат 4 типов фильтров: oil, air, cabin, fuel
- Мягкая дизамбигуация (fuel, AC, объем двигателя)
- Простой HTML интерфейс без фреймворков

**Инфраструктура:**
- Railway (Node.js + TypeScript + PostgreSQL)
- Без фоновых воркеров
- Минимальные зависимости

### ❌ Исключено из MVP

**API:**
- Дополнительные эндпоинты (кроме `/api/lookup` и `/health`)
- REST API для CRUD операций
- GraphQL
- WebSocket соединения

**UI/UX:**
- React, Vue, Angular или другие фреймворки
- Мобильные приложения
- PWA функциональность
- Сложная анимация

**Функциональность:**
- Пользовательские аккаунты и аутентификация
- Избранное и история поиска
- Уведомления и алерты
- Экспорт результатов

**Инфраструктура:**
- Микросервисная архитектура
- Redis кеширование
- CDN
- Мониторинг и алерты
- CI/CD пайплайны

## Найденные отклонения от MVP

### 1. Дополнительный эндпоинт `/api/lookup/text`

**Отклонение:** В `src/routes.ts` присутствует эндпоинт `POST /api/lookup/text`, который не был заявлен в MVP.

**Риски:**
- Усложнение API без явной необходимости
- Дополнительная поддержка и тестирование
- Нарушение принципа "один эндпоинт"

**Статус:** Требует решения

### 2. Неиспользуемые таблицы в схеме БД

**Отклонение:** В `schema.sql` присутствовали таблицы `part` и `xref`, которые не использовались в текущей логике.

**Решение:** Таблицы перенесены в `migrations/002_future_parts.sql` для использования в v1.0.

**Статус:** Исправлено

### 3. Отсутствие валидации входных данных

**Отклонение:** В `src/lookup.ts` минимальная валидация входных параметров.

**Решение:** Добавлена валидация на уровне маршрута в `routes.ts`.

**Статус:** Исправлено

### 4. Отсутствие обработки ошибок

**Отклонение:** Базовая обработка ошибок без детального логирования.

**Решение:** Добавлен централизованный error handler в `server.ts`.

**Статус:** Исправлено

## Гвардрайлы MVP

### 1. Запрет на новые зависимости
- ❌ Не добавлять новые npm пакеты без явной необходимости
- ❌ Не использовать фреймворки для UI
- ❌ Не добавлять ORM (использовать только `pg`)

### 2. Запрет на расширение API
- ❌ Не добавлять новые эндпоинты
- ❌ Не изменять существующие эндпоинты
- ❌ Не добавлять middleware без необходимости

### 3. Запрет на усложнение UI
- ❌ Не использовать React/Vue/Angular
- ❌ Не добавлять сложную анимацию
- ❌ Не создавать мобильные приложения

### 4. Запрет на новые сервисы
- ❌ Не добавлять Redis
- ❌ Не добавлять CDN
- ❌ Не добавлять внешние API

### 5. Принцип минимализма
- ✅ Один эндпоинт для поиска
- ✅ Простой HTML интерфейс
- ✅ Минимальные зависимости
- ✅ Прямые SQL запросы

### 6. Защита от дрейфа MVP
- ❌ **ЗАПРЕЩЕНО** добавлять новые эндпоинты без обновления DECISIONS.md (ADR)
- ❌ **ЗАПРЕЩЕНО** добавлять новые зависимости без отдельного PR-обоснования
- ❌ **ЗАПРЕЩЕНО** изменять API без обновления документации
- ✅ Все изменения должны проходить через GitHub Actions guardrails
- ✅ Нарушения гвардрайлов блокируют merge в main

## Обоснование изменений

### Критерии для добавления функций
1. **Критичность**: Функция критически необходима для MVP
2. **Простота**: Реализация не усложняет архитектуру
3. **Соответствие**: Функция соответствует заявленным целям MVP
4. **Минимальность**: Изменения минимальны и не нарушают гвардрайлы

### Процесс принятия решений
1. **Анализ**: Оценить необходимость изменения
2. **Документирование**: Записать в DECISIONS.md
3. **Обсуждение**: Согласовать с командой
4. **Реализация**: Внести минимальные изменения
5. **Тестирование**: Проверить соответствие MVP

## Proposed minimal diffs

### 1. Удаление эндпоинта `/api/lookup/text`

**Файл:** `src/routes.ts`
```diff
- router.post('/api/lookup/text', async (req, res) => {
-   try {
-     const payload = req.body ?? {};
-     const out = await lookup(payload);
-     const lang = payload.lang === 'ru' ? 'ru' : 'es-AR';
-     const text = toWhatsappText(out, lang);
-     res.json({ text, structured: out });
-   } catch (e: any) {
-     const status = e?.status ?? 500;
-     res.status(status).json({ error: e.message ?? 'Internal error' });
-   }
- });
```

**Обоснование:** Упрощение API до одного эндпоинта согласно MVP.

### 2. Удаление неиспользуемых таблиц

**Файл:** `schema.sql`
```diff
- CREATE TABLE IF NOT EXISTS part (
-   id BIGSERIAL PRIMARY KEY,
-   brand TEXT NOT NULL,
-   part_number TEXT NOT NULL,
-   filter_type TEXT NOT NULL CHECK (filter_type IN ('oil','air','cabin','fuel')),
-   UNIQUE (brand, part_number, filter_type)
- );
- 
- CREATE TABLE IF NOT EXISTS xref (
-   id BIGSERIAL PRIMARY KEY,
-   part_src_id BIGINT REFERENCES part(id) ON DELETE CASCADE,
-   part_dst_id BIGINT REFERENCES part(id) ON DELETE CASCADE,
-   confidence NUMERIC(3,2) DEFAULT 0.80,
-   source_brand TEXT
- );
- 
- CREATE INDEX IF NOT EXISTS idx_part_key ON part(brand, part_number, filter_type);
```

**Обоснование:** Упрощение схемы БД до необходимого минимума.

### 3. Удаление неиспользуемого импорта

**Файл:** `src/routes.ts`
```diff
- import { toWhatsappText } from './formatter.js';
```

**Обоснование:** Удаление неиспользуемого кода после удаления эндпоинта.

### 4. Упрощение скрипта импорта

**Файл:** `scripts/import_csv.ts`
```diff
-       await pool.query(
-         `INSERT INTO part (brand, part_number, filter_type)
-          VALUES ($1,$2,$3)
-          ON CONFLICT (brand, part_number, filter_type) DO NOTHING`,
-         [vals.brand_src, vals.part_number, vals.filter_type]
-       );
```

**Обоснование:** Удаление логики работы с неиспользуемой таблицей `part`.

## Мониторинг соблюдения гвардрайлов

### Автоматические проверки
- Линтеры для проверки зависимостей
- Тесты для проверки API эндпоинтов
- Проверки схемы БД

### Ручные проверки
- Code review перед мержем
- Регулярный аудит зависимостей
- Проверка соответствия документации

### Метрики MVP
- Время ответа API < 100ms
- Доступность > 99%
- Размер bundle < 1MB
- Количество зависимостей < 10
