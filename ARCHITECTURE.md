# Архитектура системы

## Обзор компонентов

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Веб-клиент    │    │   Express API   │    │   PostgreSQL    │
│  (public/)      │◄──►│   (src/)        │◄──►│   (catalog_hit)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │   CSV Import     │
                       │  (scripts/)      │
                       └─────────────────┘
```

## Компоненты системы

### 1. Веб-интерфейс (`public/index.html`)
- **Назначение**: Простой HTML-интерфейс для поиска фильтров
- **Технологии**: Vanilla HTML/CSS/JavaScript
- **Функции**:
  - Форма ввода (марка, модель, год)
  - Вызов API `/api/lookup`
  - Отображение результатов по типам фильтров
  - Обработка дизамбигуации

### 2. API сервер (`src/server.ts`)
- **Назначение**: Express.js сервер для обработки запросов
- **Порт**: 8080 (настраивается через `PORT`)
- **Эндпоинты**:
  - `GET /` — отдача `index.html`
  - `GET /health` — проверка состояния
  - `POST /api/lookup` — основной поиск
  - `POST /api/lookup/text` — поиск с форматированием для WhatsApp

### 3. Модуль поиска (`src/lookup.ts`)
- **Назначение**: Основная логика поиска и дизамбигуации
- **Алгоритм**:
  1. Поиск по `make`, `model`, `year` в таблице `catalog_hit`
  2. Фильтрация по hints (`fuel`, `ac`, `displacement_l`)
  3. Группировка по типам фильтров (`oil`, `air`, `cabin`, `fuel`)
  4. Расчет confidence score для каждого результата
  5. Определение необходимости дизамбигуации

### 4. База данных (`schema.sql`)
- **Таблица `catalog_hit`**: Основные данные каталогов
- **Таблица `ingestion_batch`**: Логирование импортов
- **Таблица `part`**: Нормализованные детали (для будущего использования)
- **Таблица `xref`**: Связи между деталями (для будущего использования)

### 5. ETL процесс (`scripts/import_csv.ts`)
- **Назначение**: Импорт CSV файлов в базу данных
- **Процесс**:
  1. Парсинг CSV файла
  2. Валидация обязательных колонок
  3. Создание `ingestion_batch` записи
  4. Массовая вставка в `catalog_hit`
  5. Создание записей в `part` таблице

## Поток данных

### Поиск фильтров
```
1. Клиент → POST /api/lookup
2. routes.ts → lookup.ts
3. lookup.ts → PostgreSQL (SELECT)
4. lookup.ts → обработка результатов
5. lookup.ts → расчет confidence
6. lookup.ts → определение дизамбигуации
7. routes.ts → JSON ответ клиенту
```

### Импорт данных
```
1. CSV файл → scripts/import_csv.ts
2. Парсинг и валидация
3. Создание ingestion_batch
4. Массовая вставка в catalog_hit
5. Создание записей в part
6. Логирование результатов
```

## Дизамбигуация

Система автоматически определяет случаи, когда нужны дополнительные уточнения:

1. **Тип топлива** (`fuel`): если найдены варианты с `nafta` и `diesel`
2. **Кондиционер** (`ac`): если есть варианты с `true` и `false`
3. **Объем двигателя** (`displacement_l`): если найдены разные значения

Приоритет вопросов: `fuel` → `ac` → `displacement_l`

## Confidence Score

Алгоритм расчета уверенности (0.50-0.99):
- Базовая оценка: 0.40
- Совпадение топлива: +0.35
- Совпадение AC: +0.25  
- Совпадение объема: +0.25
- Наличие engine_code: +0.10

## Масштабирование

### Текущие ограничения
- Один экземпляр приложения
- Прямые SQL запросы без кеширования
- Синхронная обработка запросов

### Возможные улучшения (вне MVP)
- Redis кеш для частых запросов
- Индексы по дополнительным полям
- Асинхронная обработка импорта
- Микросервисная архитектура
