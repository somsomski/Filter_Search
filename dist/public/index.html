<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Filtro Lookup (AR)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    .row { display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
    input, select, button { padding:8px; font-size:16px; }
    .card { border:1px solid #ddd; border-radius:10px; padding:12px; margin:10px 0; }
    h2 { margin: 12px 0 6px; }
    small { color:#666; }
    .chip { display:inline-block; background:#e3f2fd; border:1px solid #2196f3; border-radius:16px; padding:4px 12px; margin:2px; font-size:14px; cursor:pointer; }
    .chip:hover { background:#bbdefb; }
    .chip::after { content: ' ×'; color:#666; margin-left:4px; }
    .empty-section { color:#999; font-style:italic; text-align:center; padding:20px; }
  </style>
</head>
<body>
  <h1>Buscador de filtros (Argentina)</h1>
  <div class="row">
    <input id="make" placeholder="Marca (ej: Peugeot)" />
    <input id="model" placeholder="Modelo (ej: 208)" />
    <input id="year" type="number" placeholder="Año (ej: 2019)" />
    <select id="lang">
      <option value="es-AR" selected>es-AR</option>
      <option value="ru">ru</option>
    </select>
    <button id="btn">Buscar</button>
  </div>

  <div id="ask" class="card" style="display:none"></div>
  <div id="hints" class="card" style="display:none"></div>
  <div id="out"></div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const api = (path)=>path;
    
    let currentQuery = {};
    
    async function run(hints = {}) {
      const make = $('#make').value.trim();
      const model = $('#model').value.trim();
      const year = Number($('#year').value);
      const lang = $('#lang').value;
      
      currentQuery = { make, model, year, lang, hints };
      
      const resp = await fetch(api('/api/lookup'), {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(currentQuery)
      });
      const data = await resp.json();
      
      const ask = document.getElementById('ask');
      ask.style.display = 'none';
      ask.innerHTML = '';
      
      if (data.disambiguation?.needed) {
        ask.style.display = 'block';
        const q = data.disambiguation.ask?.[0];
        const txt = (lang==='ru')
          ? (data.disambiguation.fallback_texts?.['ru'] || 'Нужен уточняющий пункт')
          : (data.disambiguation.fallback_texts?.['es-AR'] || 'Falta un dato');
        
        let askHTML = `<b>⚠️ ${txt}</b><br/><small>${q?.reason || ''}</small><br/>`;
        
        if (q?.field === 'fuel') {
          askHTML += '<div style="margin-top:10px;">';
          askHTML += '<button onclick="answerFuel(\'nafta\')" style="margin-right:8px;">Nafta</button>';
          askHTML += '<button onclick="answerFuel(\'diesel\')">Diesel</button>';
          askHTML += '</div>';
        } else if (q?.field === 'ac') {
          askHTML += '<div style="margin-top:10px;">';
          askHTML += '<button onclick="answerAC(false)" style="margin-right:8px;">Estándar (CU)</button>';
          askHTML += '<button onclick="answerAC(true)">Carbón activo/bio (CUK/FP)</button>';
          askHTML += '</div>';
        } else if (q?.field === 'displacement_l') {
          askHTML += '<div style="margin-top:10px;">';
          askHTML += '<input id="displacementInput" type="number" step="0.1" placeholder="ej: 1.6" style="margin-right:8px;"/>';
          askHTML += '<button onclick="answerDisplacement()">Confirmar</button>';
          askHTML += '</div>';
        }
        
        ask.innerHTML = askHTML;
      }
      
      // Показываем активные hints
      const hintsDiv = document.getElementById('hints');
      hintsDiv.style.display = 'none';
      hintsDiv.innerHTML = '';
      
      if (hints && Object.keys(hints).length > 0) {
        hintsDiv.style.display = 'block';
        let hintsHTML = '<b>Active filters / Активные фильтры:</b><br/>';
        
        if (hints.fuel) {
          hintsHTML += `<span class="chip" onclick="clearHint('fuel')">fuel: ${hints.fuel}</span>`;
        }
        if (hints.ac !== undefined) {
          const acLabel = hints.ac ? 'Carbón activo/bio (CUK/FP)' : 'Estándar (CU)';
          hintsHTML += `<span class="chip" onclick="clearHint('ac')">ac: ${acLabel}</span>`;
        }
        if (hints.displacement_l) {
          hintsHTML += `<span class="chip" onclick="clearHint('displacement_l')">displacement_l: ${hints.displacement_l}</span>`;
        }
        
        hintsDiv.innerHTML = hintsHTML;
      }
      
      const out = document.getElementById('out');
      out.innerHTML = '';
      
      function section(title, items) {
        const div = document.createElement('div'); 
        div.className='card';
        
        if (!items || !items.length) {
          div.innerHTML = `<h2>${title}</h2><div class="empty-section">— No entries / Нет позиций —</div>`;
        } else {
          div.innerHTML = `<h2>${title}</h2>` + items.map(it => {
            const srcs = (it.sources||[]).map(s=>`${s.catalog} p.${s.page}`).join(', ');
            return `<div><b>${it.brand} ${it.part_number}</b> — conf ${Math.round(it.confidence*100)}%<br/><small>${srcs}</small></div>`;
          }).join('');
        }
        out.appendChild(div);
      }
      
      section('Aceite / Масляный', data.results?.oil);
      section('Aire / Воздушный', data.results?.air);
      section('Cabina / Салонный', data.results?.cabin);
      section('Combustible / Топливный', data.results?.fuel);
      
      // Автоскролл к результатам после ответа на дизамбигуацию
      if (hints && Object.keys(hints).length > 0) {
        setTimeout(() => {
          document.getElementById('out').scrollIntoView({ behavior: 'smooth' });
        }, 100);
      }
    }
    
    function answerFuel(fuel) {
      run({ ...currentQuery.hints, fuel });
    }
    
    function answerAC(ac) {
      run({ ...currentQuery.hints, ac });
    }
    
    function answerDisplacement() {
      const displacement = Number($('#displacementInput').value);
      if (displacement && displacement > 0) {
        run({ ...currentQuery.hints, displacement_l: displacement });
      }
    }
    
    function clearHint(hintName) {
      const newHints = { ...currentQuery.hints };
      delete newHints[hintName];
      run(newHints);
    }
    
    document.getElementById('btn').addEventListener('click', () => run());
  </script>
</body>
</html>
