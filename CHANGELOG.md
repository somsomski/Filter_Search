# Changelog

Все значимые изменения в проекте документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

## [Unreleased]

### Added
- Полная документация проекта (README, ARCHITECTURE, API, DATA_MODEL, ETL, DEPLOY, SCOPE, DECISIONS)
- ADR (Architecture Decision Records) для ключевых решений
- Гвардрайлы MVP и анализ отклонений
- Валидация входных данных для API
- Централизованный error handler
- Миграция для будущих таблиц part/xref
- Smoke tests для проверки API функциональности
- GitHub Actions guardrails для защиты от дрейфа MVP
- Автоматическая проверка новых API маршрутов и зависимостей

### Changed
- **BREAKING**: Единая форма ответа `/api/lookup` - всегда возвращает объект `results` с 4 ключами (`oil`, `air`, `cabin`, `fuel`)
- **BREAKING**: Пошаговая дизамбигуация - задается только один вопрос за раз по приоритету (fuel → ac → displacement_l)
- Улучшена валидация входных данных с конкретными сообщениями об ошибках
- Обновлены smoke тесты для проверки новых требований
- Обновлена документация API с описанием изменений
- Обновлен README.md с подробными инструкциями и секцией Guardrails
- Улучшена структура документации
- Упрощен скрипт импорта (убрана логика part/xref)
- Улучшено логирование импорта
- Обновлен SCOPE.md с правилами защиты от дрейфа MVP

### Fixed
- Удален эндпоинт /api/lookup/text (нарушение MVP)
- Перенесены таблицы part/xref в отдельную миграцию
- Добавлена валидация входных данных
- Улучшена обработка ошибок
- Исправлен dev скрипт (заменен tsx на встроенный loader)
- Упрощен GitHub Actions (убрано дублирование проверок)

### Removed
- Эндпоинт POST /api/lookup/text
- Таблицы part и xref из основной схемы
- Импорт toWhatsappText из routes.ts
- Логика работы с таблицей part в скрипте импорта

## [0.1.0] - 2024-01-15

### Added
- Базовая архитектура проекта
- Express.js сервер с TypeScript
- PostgreSQL схема базы данных
- API эндпоинт `/api/lookup` для поиска фильтров
- Эндпоинт `/health` для проверки состояния
- Эндпоинт `/api/lookup/text` для WhatsApp форматирования
- HTML интерфейс для поиска фильтров
- Скрипт импорта CSV данных
- Поддержка дизамбигуации (fuel, AC, displacement)
- Confidence scoring для результатов
- Поддержка языков es-AR и ru
- Railway конфигурация для деплоя
- Nixpacks конфигурация

### Technical Details
- **Backend**: Node.js + Express + TypeScript
- **Database**: PostgreSQL с таблицами catalog_hit, ingestion_batch, part, xref
- **Frontend**: Vanilla HTML/CSS/JavaScript
- **Deployment**: Railway с автоматическим деплоем
- **Dependencies**: express, cors, pg, typescript

### Data Model
- Таблица `catalog_hit` с полями для автомобилей и фильтров
- Таблица `ingestion_batch` для логирования импортов
- Индексы для оптимизации поиска
- Поддержка 4 типов фильтров: oil, air, cabin, fuel

### API Specification
- POST `/api/lookup` - основной поиск
- POST `/api/lookup/text` - поиск с текстовым форматированием
- GET `/health` - проверка состояния
- Поддержка hints для дизамбигуации
- Confidence scoring от 0.50 до 0.99

### ETL Process
- Импорт CSV файлов через `scripts/import_csv.ts`
- Валидация обязательных колонок
- Создание batch записей для отслеживания
- Обработка ошибок импорта

## [0.0.1] - 2024-01-14

### Added
- Инициализация проекта
- Базовая структура файлов
- Первые коммиты в репозиторий

---

## Примечания по версионированию

### Семантическое версионирование
- **MAJOR**: Изменения, нарушающие обратную совместимость
- **MINOR**: Новая функциональность с сохранением совместимости
- **PATCH**: Исправления ошибок

### Критерии для релизов
- **MVP релиз**: Полная функциональность согласно требованиям
- **Patch релиз**: Исправления критических ошибок
- **Minor релиз**: Новые функции в рамках MVP

### Процесс релиза
1. Обновление версии в `package.json`
2. Создание git tag
3. Обновление CHANGELOG.md
4. Деплой на Railway
5. Создание GitHub release

## Планы на будущее

### Версия 0.2.0 (после MVP)
- Удаление неиспользуемых таблиц и эндпоинтов
- Улучшение валидации входных данных
- Добавление детального логирования
- Оптимизация производительности

### Версия 0.3.0 (расширение функциональности)
- Поддержка дополнительных источников каталогов
- Улучшение алгоритма дизамбигуации
- Кеширование частых запросов
- Мониторинг и алерты

### Версия 1.0.0 (production ready)
- Полная стабилизация API
- Комплексное тестирование
- Документация для пользователей
- SLA и гарантии производительности
